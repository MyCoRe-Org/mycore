<?xml version="1.0" encoding="ISO-8859-1"?>

<!-- build.xml - build file for the MyCoRe API -->

<project default="usage" basedir=".">

  <!-- =================================================================== -->
  <!-- Constant values                                                     -->
  <!-- =================================================================== -->

  <!-- compiler -->
  <property name="build.compiler" value="classic"/>
  <property name="debug" value="on"/>
  <property name="optimize" value="on"/>
  <property name="deprecation" value="on"/>

  <!-- persistency -->
  <property name="persistency"  value="cm7"/>

  <!-- PDF generation -->
  <property name="doclets" value="/mycore/cvs/doclets" />
    
  <!-- classpath -->
  <property name="build.sysclasspath" value="last"/>

  <path id="mycore.classpath">
    <fileset dir="${basedir}/lib">
      <include name="*.jar"/>
    </fileset>
  </path>

  <!-- CVS repository -->
  <property name="CVSRoot" value="server.mycore.de:/cvs" />

  <!-- =================================================================== -->
  <!-- Help on usage                                                       -->
  <!-- =================================================================== -->
  <target name="usage">
    <echo>
    
 ----------------------- MyCoRe build file ---------------------------
    
   available targets are:
   
      package     --> generates class files, jar and javadocs
      compile     --> compiles the source code
      compile_pkg --> compiles mycore subpackage pkg
      javadocs    --> generates the JavaDoc API documentation
      update      --> do a cvs update -dP
      jar         --> creates /lib/mycore.jar containing all MyCoRe classes
      clean       --> cleans up the directory, removes all generated files

   There are some other targets only for internal use, ignore them.   
   See the comments inside the build.xml file for more details.

 ---------------------------------------------------------------------
  
    </echo>
  </target>

  <!-- =================================================================== -->
  <!-- The initalization for all                                           -->
  <!-- =================================================================== -->
  <target name="init" >
   <mkdir dir="${basedir}/classes"/>
   <mkdir dir="${basedir}/javadocs"/>
  </target>
  
  <!-- =================================================================== -->
  <!-- Creates the class package                                           -->
  <!-- =================================================================== -->
  <target name="package" depends="jar,javadocs">
  </target>

  <!-- =================================================================== -->
  <!-- Creates a mycore.jar file containing all compiled MyCoRe classes    -->
  <!-- =================================================================== -->
  <target name="jar" depends="compile">
    <jar jarfile="${basedir}/lib/mycore.jar" basedir="${basedir}/classes"/>
  </target>
  
  <!-- =================================================================== -->
  <!-- Compiles the sources                                                -->
  <!-- =================================================================== -->

  <target name="javac" depends="init">
    <javac srcdir="${basedir}/sources"
           destdir="${basedir}/classes"
           includes="${packages}"
           classpathref="mycore.classpath"
           debug="${debug}"
           optimize="${optimize}"
           deprecation="on">
    </javac>
  </target>

  <target name="compile" depends="compile_common, compile_servlets, compile_user, compile_metadata, compile_classifications, compile_nbn, compile_editor, compile_cli, compile_ifs, compile_remote, compile_sql, compile_oai, compile_query, compile_persistency"/>

  <target name="compile_common">
    <antcall target="javac">
      <param name="packages" value="org/mycore/common/**"/>
    </antcall>
  </target>

  <target name="compile_persistency">
    <echo>Compiling for persistence layer ${persistency}</echo>
    <antcall target="javac">
      <param name="packages" value="org/mycore/backend/${persistency}/**"/>
    </antcall>
  </target>

  <target name="compile_sql">
    <antcall target="javac">
      <param name="packages" value="org/mycore/backend/sql/**"/>
    </antcall>
  </target>

  <target name="compile_oai">
    <antcall target="javac">
      <param name="packages" value="org/mycore/services/oai/**"/>
    </antcall>
  </target>

  <target name="compile_ifs">
    <antcall target="javac">
      <param name="packages" value="org/mycore/datamodel/ifs/**, org/mycore/backend/filesystem/**, org/mycore/backend/realhelix/**, org/mycore/backend/videocharger/**"/>
    </antcall>
  </target>

  <target name="compile_remote">
    <antcall target="javac">
      <param name="packages" value="org/mycore/backend/remote/**"/>
    </antcall>
  </target>

  <target name="compile_metadata">
    <antcall target="javac">
      <param name="packages" value="org/mycore/datamodel/metadata/**"/>
    </antcall>
  </target>

  <target name="compile_classifications">
    <antcall target="javac">
      <param name="packages" value="org/mycore/datamodel/classifications/**"/>
    </antcall>
  </target>

  <target name="compile_editor">
    <antcall target="javac">
      <param name="packages" value="org/mycore/frontend/editor/**"/>
    </antcall>
  </target>

  <target name="compile_user">
    <antcall target="javac">
      <param name="packages" value="org/mycore/user/**"/>
    </antcall>
  </target>

  <target name="compile_cli">
    <antcall target="javac">
      <param name="packages" value="org/mycore/frontend/cli/**"/>
    </antcall>
  </target>

  <target name="compile_servlets">
    <antcall target="javac">
      <param name="packages" value="org/mycore/frontend/servlets/**"/>
    </antcall>
  </target>

  <target name="compile_nbn">
    <antcall target="javac">
      <param name="packages" value="org/mycore/services/nbn/**"/>
    </antcall>
  </target>

  <target name="compile_query">
    <antcall target="javac">
      <param name="packages" value="org/mycore/services/query/**"/>
    </antcall>
  </target>

  <!-- =================================================================== -->
  <!-- Check if javadocs and pdf are up to date or outdated                -->
  <!-- =================================================================== -->

  <target name="up2date" depends="init">

    <condition property="javadocs.outdated">
      <not>
        <uptodate>
          <srcfiles dir="${basedir}/sources" includes="**/*.java" />
          <srcfiles dir="${basedir}/sources" includes="**/*.html" />
          <mapper type="merge" to="${basedir}/javadocs/overview-tree.html"/>
        </uptodate>
      </not>
    </condition>

    <condition property="pdf.outdated">
      <not>
        <uptodate>
          <srcfiles dir="${basedir}/sources" includes="**/*.java" />
          <srcfiles dir="${doclets}" includes="pdfdoclet-mycore.properties" />
          <mapper type="merge" to="${basedir}/javadocs/javadocs.pdf"/>
        </uptodate>
      </not>
    </condition>

  </target>

  <!-- =================================================================== -->
  <!-- Create the HTML JavaDocs from sources                               -->
  <!-- =================================================================== -->

  <target name="javadocs" depends="up2date" if="javadocs.outdated">
    <echo>

      Building the MyCoRe source code JavaDoc documentation...

      NOTE: Under AIX, you have to do the following to make this work:
      ln -s /usr/java_dev2/lib/tools.jar /usr/java_dev2/jre/lib/ext/tools.jar
    </echo>
    <javadoc
      packagenames        = "org.mycore.*"
      excludepackagenames = "org.mycore.backend.cm8"
      sourcepath          = "${basedir}/sources"
      destdir             = "${basedir}/javadocs"
      classpathref        = "mycore.classpath"
      author              = "true"
      version             = "true"
      use                 = "true"
      access              = "package"
      splitindex          = "true"
      windowtitle         = "MyCoRe JavaDoc Documentation"
      doctitle            = "MyCoRe Source Code JavaDoc Documentation"
    >
      <group title="MyCoRe Datamodel"                           packages="org.mycore.datamodel*" />
      <group title="MyCoRe Persistence Backend Implementations" packages="org.mycore.backend*"   />
      <group title="MyCoRe User Interface Frontend"             packages="org.mycore.frontend*"  />
      <group title="MyCoRe Common Functionality"                packages="org.mycore.common*"    />
      <group title="MyCoRe Services"                            packages="org.mycore.services*"  />
      <group title="MyCoRe User and Group Management"           packages="org.mycore.user*"      />

      <link href="http://www.mycore.de/library/jdk1.2.2/docs/api"/>
      <link href="http://www-3.ibm.com/software/data/eip/pubs/v7/frnjapr/java"/>
      <link href="http://www.mycore.de/tomcat/documentation/docs/api"/>
      <link href="http://www.mycore.de/library/jaxp/docs/api"/>
      <link href="http://www.jdom.org/docs/apidocs"/>
      <link href="http://www.xmldb.org/xapi/api"/>
      <link href="http://www.mycore.de/library/log4j/api"/>
    </javadoc>
  </target>

  <!-- =================================================================== -->
  <!-- Create the PDF JavaDocs from sources                                -->
  <!-- =================================================================== -->

  <target name="java2pdf" depends="up2date" if="pdf.outdated">
    <echo>

      Building the MyCoRe source code documentation as PDF...

      NOTE: Under AIX, you have to do the following to make this work:
      ln -s /usr/java_dev2/lib/tools.jar /usr/java_dev2/jre/lib/ext/tools.jar
    </echo>
    <javadoc
      packagenames        = "org.mycore.*"
      excludepackagenames = "org.mycore.backend.cm8"
      sourcepath          = "${basedir}/sources"
      classpathref        = "mycore.classpath"
      author              = "true"
      version             = "true"
      access              = "package"
    >
      <doclet 
        name = "com.tarsec.javadoc.pdfdoclet.PDFDoclet"
        path = "${doclets}/itext-0.92.jar:${doclets}/pdfdoclet.jar" >                                                                                         
        <param name="-pdf"    value="${basedir}/javadocs/javadocs.pdf" />             
        <param name="-config" value="${doclets}/pdfdoclet-mycore.properties" />  
      </doclet>             
 
    </javadoc>
  </target>

  <!-- =================================================================== --> 
  <!-- Create the PDF documentation from LaTeX sources                     --> 
  <!-- =================================================================== --> 
    
  <target name="tex2pdf"> 
    <echo> 
   
      Building the MyCoRe documentation from LaTeX sources... 
    </echo> 
    
    <exec dir="documentation" executable="pdflatex"> <arg line="Overview.tex"  /> </exec> 
    <exec dir="documentation" executable="pdflatex"> <arg line="Overview.tex"  /> </exec> 
    <exec dir="documentation" executable="pdflatex"> <arg line="UserGuide.tex" /> </exec> 
    <exec dir="documentation" executable="pdflatex"> <arg line="UserGuide.tex" /> </exec>
    <exec dir="documentation" executable="pdflatex"> <arg line="ProgGuide.tex" /> </exec>
    <exec dir="documentation" executable="pdflatex"> <arg line="ProgGuide.tex" /> </exec>
    <exec dir="documentation" executable="pdflatex"> <arg line="HowToWriteTheManual" /> </exec>
    <exec dir="documentation" executable="pdflatex"> <arg line="HowToWriteTheManual" /> </exec>
    
  </target> 

  <!-- =================================================================== -->
  <!-- Remove the user created directories and files                       -->
  <!-- =================================================================== -->

  <target name="clean" depends="init">
    <delete includeEmptyDirs="true" >
      <fileset dir="${basedir}/javadocs" />
      <fileset dir="${basedir}/classes"  />
      <fileset dir="${basedir}/documentation" includes="*.toc *.aux *.dvi *.lof *.lot *.log" />
    </delete>
    <delete file="${basedir}/lib/mycore.jar" />
  </target>

  <!-- =================================================================== -->
  <!-- Update current working directory from CVS repository                -->
  <!-- =================================================================== -->

  <target name="update">
    <cvs
      cvsroot="${CVSRoot}"
      command="update -dP"
      dest="${basedir}"
    />
  </target>

  <!-- =================================================================== -->
  <!-- Build CVS ChangeLog                                                 -->
  <!-- =================================================================== -->

  <target name="changelog" depends="init">
    <echo>

      Building CVS ChangeLog, please be patient...
    </echo>

    <antcall target="do-log"><param name="changelog-year" value="2003" /></antcall>
    <antcall target="do-log"><param name="changelog-year" value="2002" /></antcall>
    <antcall target="do-log"><param name="changelog-year" value="2001" /></antcall>
  </target>

  <target name="do-log">
    <echo>Logging changes of the year ${changelog-year}...</echo>

    <cvschangelog 
      dir      = "."
      destfile = "${basedir}/javadocs/changelog-${changelog-year}.xml" 
      start    = "1 Jan ${changelog-year}"
      end      = "31 Dec ${changelog-year}"
    >
      <user displayname = "Frank Lützenkirchen / Essen"   userid = "dlclient" />
      <user displayname = "Frank Lützenkirchen / Essen"   userid = "mcrfluet" />
      <user displayname = "Holger Gollan / Essen"         userid = "mcrhgoll" />
      <user displayname = "Detlev Degenhardt / Freiburg"  userid = "mcrddege" />
      <user displayname = "Harald Richter / Essen"        userid = "mcrhrich" />
      <user displayname = "Jens Kupferschmidt / Leipzig"  userid = "mcrjkupf" />
      <user displayname = "Mathias Hegner / Jena"         userid = "mcrmhegn" />
      <user displayname = "Marc Schlüppmann / Essen"      userid = "mcrmslue" />
      <user displayname = "Thorsten Agemar / Göttingen"   userid = "mcrtagem" />
      <user displayname = "Thomas Scheffler / Jena"       userid = "mcrukroe" />
      <user displayname = "Werner Gresshoff / Münster"    userid = "mcrwgres" />
      <user displayname = "Benno Süselbeck / Münster"     userid = "mcrbsuse" />
      <user displayname = ""Johannes Bühler / Greifswald" userid = "mcrjbueh" />
      <user displayname = "Maik Bunschkowski / Rostock"   userid = "mcrldbis" /> 
    </cvschangelog>

    <style 
      in           = "${basedir}/javadocs/changelog-${changelog-year}.xml" 
      out          = "${basedir}/javadocs/changelog-${changelog-year}.html" 
      style        = "${ant.home}/etc/changelog.xsl"
      classpathref = "mycore.classpath"
    >
      <param name="title"  expression="MyCoRe CVS ChangeLog for the year ${changelog-year}" />
      <param name="module" expression="mycore" />
      <param name="cvsweb" expression="http://www.mycore.de/repository/cgi-bin/viewcvs.cgi/" />
    </style>

    <delete file="${basedir}/javadocs/changelog-${changelog-year}.xml" />
  </target>

  <!-- =================================================================== -->
  <!-- Do work after a CVS commit...                                       -->
  <!-- =================================================================== -->

  <target name="postcommit" depends="update, javadocs, java2pdf, tex2pdf">
    <antcall target="do-log"><param name="changelog-year" value="2003" /></antcall>
  </target>

</project>

