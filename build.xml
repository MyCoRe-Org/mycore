<?xml version="1.0" encoding="ISO-8859-1"?>

  <!-- =================================================================== -->
  <!-- MyCoRe build file for use with Apache Ant                           -->
  <!-- $Revision: 1.60 $ $Date: 2003-08-20 10:07:40 $                      -->
  <!-- =================================================================== -->

<project default="usage" basedir=".">

  <!-- =================================================================== -->
  <!-- Global properties you normally should not change                    -->
  <!-- =================================================================== -->

  <!-- Javac properties -->
  <property name="debug"       value="on"  />
  <property name="optimize"    value="on"  />
  <property name="deprecation" value="off" />

  <!-- Read in all environment variables -->
  <property environment="env" />

  <!-- Read in properties from bin/build.properties -->
  <property file="${basedir}/bin/build.properties" />

  <!-- MyCoRe CVS repository root -->
  <property name="CVSRoot" value="server.mycore.de:/cvs" />

  <!-- Path where PDF doclet is installed -->
  <property name="doclets" value="/mycore/cvs/doclets" />

  <!-- =================================================================== -->
  <!-- Some help on using ant with this build file                         -->
  <!-- =================================================================== -->

  <target name="usage">
    <echo>
      Usage:
        build.sh [target]          or
        build.cmd [target]         or
        ant [target]

      Available targets are:
        info          --> Shows Java/Ant/Operating System version, CLASSPATH etc.
        jar           --> Creates file lib/mycore-for-*.jar containing all compiled classes
        compile       --> Compiles all source code to directory classes
        compile_[pkg] --> Compiles only a certain package (see build.xml for details)
        javadocs      --> Generates JavaDoc API documentation as HTML in directory documentation/html
        tex2pdf       --> Generates all LaTeX documentations as PDF files (requires external pdflatex command)
        clean         --> Removes all compiled classes and javadocs, cleaning up

      Please do not use any of the other targets, they are internal.
    </echo>
  </target>

  <!-- =================================================================== -->
  <!-- Output environment variables, software and operating system version -->
  <!-- =================================================================== -->

  <target name="info" depends="init" description="display software and os versions">
    <property name="output.classpath" refid="mycore.classpath" />

    <echo>Base directory   : ${basedir}</echo>
    <echo>Operating system : ${os.name} Version ${os.version} on ${os.arch} </echo>
    <echo>Java version     : JDK ${ant.java.version} Version ${java.version} from ${java.vendor}</echo>
    <echo>Java home        : ${env.JAVA_HOME}</echo>
    <echo>Ant build file   : $Revision: 1.60 $ $Date: 2003-08-20 10:07:40 $</echo>
    <echo>Ant version      : ${ant.version}</echo>
    <echo>Ant home         : ${env.ANT_HOME}</echo>
    <echo>XML Store type   : ${MCR.XMLStore.Type}</echo>
    <echo>JDBC Store type  : ${MCR.JDBCStore.Type}</echo>
    <echo>System CLASSPATH : ${build.sysclasspath}</echo>
    <echo>Active CLASSPATH : ${output.classpath}</echo>
  </target>

  <!-- =================================================================== -->
  <!-- Initialize directories and build CLASSPATH for compiling sources    -->
  <!-- =================================================================== -->

  <target name="init" depends="jdbcstore.path.1, jdbcstore.path.2, xmlstore.path.1, xmlstore.path.2" >
    <echo>Initializing directories and classpath...</echo>

    <mkdir dir="${basedir}/classes" />
    <mkdir dir="${basedir}/documentation/html" />
    <mkdir dir="${basedir}/documentation/pdf"  /> 

    <!-- Fail if environment variables are not set -->
    <fail message="Environment variable JAVA_HOME is not set!" unless="env.JAVA_HOME" />

    <path id="mycore.classpath">
      <fileset dir="${basedir}/lib" includes="*.jar"/>
      <path refid="jdbc.classpath" />
      <path refid="xml.classpath"  />
    </path>
  </target>

  <target name="jdbcstore.path.1" if="MCR.JDBCStore.BaseDir">
    <path id="jdbc.classpath">
      <fileset dir="${MCR.JDBCStore.BaseDir}" includes="_dummy_ ${MCR.JDBCStore.Jars}"        />
      <dirset  dir="${MCR.JDBCStore.BaseDir}" includes="_dummy_ ${MCR.JDBCStore.ClassesDirs}" />
    </path>
  </target>

  <target name="jdbcstore.path.2" unless="MCR.JDBCStore.BaseDir">
    <path id="jdbc.classpath" />
  </target>

  <target name="xmlstore.path.1" if="MCR.XMLStore.BaseDir">
    <path id="xml.classpath">
      <fileset dir="${MCR.XMLStore.BaseDir}" includes="_dummy_ ${MCR.XMLStore.Jars}"        />
      <dirset  dir="${MCR.XMLStore.BaseDir}" includes="_dummy_ ${MCR.XMLStore.ClassesDirs}" /> 
    </path>
  </target>

  <target name="xmlstore.path.2" unless="MCR.XMLStore.BaseDir">
    <path id="xml.classpath" />
  </target>

  <!-- System CLASSPATH is completely ignored! -->
  <property name="build.sysclasspath" value="ignore"/>

  <!-- =================================================================== -->
  <!-- Creates a mycore-for-*.jar file containing all compiled MyCoRe classes  -->
  <!-- =================================================================== -->

  <target name="jar" depends="compile" description="creates lib/mycore-for-*.jar">
    <echo>Creating mycore-for-${MCR.XMLStore.Type}.jar containing all compiled classes...</echo>
    <jar 
      destfile="${basedir}/lib/mycore-for-${MCR.XMLStore.Type}.jar"
    >
      <fileset dir="${basedir}/classes" includes="**/*.class"       />
      <fileset dir="${basedir}/schema"  includes="*.xsd *.dtd"      />
      <fileset dir="${basedir}/bin"     includes="build.properties" />
    </jar>
    <echo>---------------------------------------------------------</echo>
  </target>
  
  <!-- =================================================================== -->
  <!-- Compiles the sources from directory sources to directory classes    -->
  <!-- =================================================================== -->

  <target name="javac" depends="init">
    <echo>Compiling ${packages}</echo>
    <javac srcdir="${basedir}/sources"
           destdir="${basedir}/classes"
           includes="${packages}"
           classpathref="mycore.classpath"
           debug="${debug}"
           optimize="${optimize}"
           deprecation="${deprecation}">
    </javac>
    <echo>---------------------------------------------------------</echo>
  </target>

  <target name="compile" description="compiles all sources to classes directory"
    depends="compile_common, compile_servlets, compile_user, compile_metadata, compile_classifications, compile_nbn, compile_editor, compile_cli, compile_ifs, compile_remote, compile_sql, compile_oai, compile_query, compile_persistency"/>

  <target name="compile_common">
    <echo>Compiling common classes...</echo>
    <antcall target="javac">
      <param name="packages" value="org/mycore/common/**"/>
    </antcall>
  </target>

  <target name="compile_persistency">
    <echo>Compiling xml persistence implementation ${MCR.XMLStore.Type}</echo>

    <!-- For internal use: setting MCR.XMLStore.Type=all will compile cm7 and cm8 and xmldb -->
    <condition property="mcr.packages" value="org/mycore/backend/${MCR.XMLStore.Type}/**">
      <not><equals arg1="${MCR.XMLStore.Type}" arg2="all" /></not>
    </condition>
    <condition property="mcr.packages" value="org/mycore/backend/cm7/**, org/mycore/backend/cm8/**, org/mycore/backend/xmldb/**">
      <equals arg1="${MCR.XMLStore.Type}" arg2="all" />
    </condition>

    <antcall target="javac">
      <param name="packages" value="${mcr.packages}"/>
    </antcall>
  </target>

  <target name="compile_sql">
    <echo>Compiling JDBC SQL access to relational databases...</echo>
    <antcall target="javac">
      <param name="packages" value="org/mycore/backend/sql/**"/>
    </antcall>
  </target>

  <target name="compile_oai">
    <echo>Compiling Open Archives Initiative OAI-PMH 2.0 client...</echo>
    <antcall target="javac">
      <param name="packages" value="org/mycore/services/oai/**"/>
    </antcall>
  </target>

  <target name="compile_ifs">
    <echo>Compiling internal logical filesystem (IFS)...</echo>
    <antcall target="javac">
      <param name="packages" value="org/mycore/datamodel/ifs/**, org/mycore/backend/filesystem/**, org/mycore/backend/realhelix/**, org/mycore/backend/videocharger/**"/>
    </antcall>
  </target>

  <target name="compile_remote">
    <echo>Compiling remote access to distributed MyCoRe systems...</echo>
    <antcall target="javac">
      <param name="packages" value="org/mycore/backend/remote/**"/>
    </antcall>
  </target>

  <target name="compile_metadata">
    <echo>Compiling metadata model classes...</echo>
    <antcall target="javac">
      <param name="packages" value="org/mycore/datamodel/metadata/**"/>
    </antcall>
  </target>

  <target name="compile_classifications">
    <echo>Compiling classification system...</echo>
    <antcall target="javac">
      <param name="packages" value="org/mycore/datamodel/classifications/**"/>
    </antcall>
  </target>

  <target name="compile_editor">
    <echo>Compiling online html-based metadata editor...</echo>
    <antcall target="javac">
      <param name="packages" value="org/mycore/frontend/editor/**"/>
    </antcall>
  </target>

  <target name="compile_user">
    <echo>Compiling users and groups system...</echo>
    <antcall target="javac">
      <param name="packages" value="org/mycore/user/**"/>
    </antcall>
  </target>

  <target name="compile_cli">
    <echo>Compiling command line interface (CLI)...</echo>
    <antcall target="javac">
      <param name="packages" value="org/mycore/frontend/cli/**"/>
    </antcall>
  </target>

  <target name="compile_servlets">
    <echo>Compiling servlets for HTML frontend...</echo>
    <antcall target="javac">
      <param name="packages" value="org/mycore/frontend/servlets/**"/>
    </antcall>
  </target>

  <target name="compile_nbn">
    <echo>Compiling support for National Bibliographic Names (NBN URNs)...</echo>
    <antcall target="javac">
      <param name="packages" value="org/mycore/services/nbn/**"/>
    </antcall>
  </target>

  <target name="compile_query">
    <echo>Compiling remote query classes...</echo>
    <antcall target="javac">
      <param name="packages" value="org/mycore/services/query/**"/>
    </antcall>
  </target>

  <!-- =================================================================== -->
  <!-- Check if javadocs and pdf are up to date or outdated                -->
  <!-- =================================================================== -->

  <target name="up2date">

    <condition property="javadocs.outdated">
      <not>
        <uptodate>
          <srcfiles dir="${basedir}/sources" includes="**/*.java" />
          <srcfiles dir="${basedir}/sources" includes="**/*.html" />
          <mapper type="merge" to="${basedir}/documentation/html/overview-tree.html"/>
        </uptodate>
      </not>
    </condition>

    <condition property="pdf.outdated">
      <not>
        <uptodate>
          <srcfiles dir="${basedir}/sources" includes="**/*.java" />
          <srcfiles dir="${doclets}" includes="pdfdoclet-mycore.properties" />
          <mapper type="merge" to="${basedir}/documentation/pdf/javadocs.pdf"/>
        </uptodate>
      </not>
    </condition>

    <condition property="exclude.cm8" value="org.mycore.backend.cm8">
      <not><available classname="com.ibm.mm.sdk.common.DKConstantICM" classpathref="mycore.classpath"/></not>
    </condition>

    <condition property="exclude.cm7" value="org.mycore.backend.cm7">
      <not><available classname="com.ibm.mm.sdk.common.DKConstantDL" classpathref="mycore.classpath"/></not>
    </condition>

  </target>

  <!-- =================================================================== -->
  <!-- Create the HTML JavaDocs from sources                               -->
  <!-- =================================================================== -->

  <target name="javadocs" depends="init,up2date" if="javadocs.outdated" description="creates JavaDoc API documentation in HTML format">
    <echo>Building the MyCoRe JavaDoc API documentation...</echo>
    <javadoc
      packagenames        = "org.mycore.*"
      excludepackagenames = "${exclude.cm7},${exclude.cm8}"
      sourcepath          = "${basedir}/sources"
      destdir             = "${basedir}/documentation/html"
      classpathref        = "mycore.classpath"
      author              = "true"
      version             = "true"
      use                 = "true"
      access              = "package"
      splitindex          = "true"
      windowtitle         = "MyCoRe JavaDoc Documentation"
      doctitle            = "MyCoRe Source Code JavaDoc Documentation"
    >
      <group title="MyCoRe Datamodel"                           packages="org.mycore.datamodel*" />
      <group title="MyCoRe Persistence Backend Implementations" packages="org.mycore.backend*"   />
      <group title="MyCoRe User Interface Frontend"             packages="org.mycore.frontend*"  />
      <group title="MyCoRe Common Functionality"                packages="org.mycore.common*"    />
      <group title="MyCoRe Services"                            packages="org.mycore.services*"  />
      <group title="MyCoRe User and Group Management"           packages="org.mycore.user*"      />

      <link href="http://www.mycore.de/library/jdk1.2.2/docs/api"/>
      <link href="http://www-3.ibm.com/software/data/eip/pubs/v7/frnjapr/java"/>
      <link href="http://www.mycore.de/tomcat/documentation/docs/api"/>
      <link href="http://www.mycore.de/library/jaxp/docs/api"/>
      <link href="http://www.jdom.org/docs/apidocs"/>
      <link href="http://www.xmldb.org/xapi/api"/>
      <link href="http://www.mycore.de/library/log4j/api"/>
    </javadoc>
    <echo>---------------------------------------------------------</echo>
  </target>

  <!-- =================================================================== -->
  <!-- Create the PDF JavaDocs from sources                                -->
  <!-- =================================================================== -->

  <target name="java2pdf" depends="init,up2date" if="pdf.outdated">
    <echo> Building the MyCoRe JavaDoc API documentation as PDF...</echo>

    <mkdir dir="${basedir}/documentation/pdf" />
    <javadoc
      packagenames        = "org.mycore.*"
      excludepackagenames = "${exclude.cm7},${exclude.cm8}"
      sourcepath          = "${basedir}/sources"
      classpathref        = "mycore.classpath"
      author              = "true"
      version             = "true"
      access              = "package"
    >
      <doclet 
        name = "com.tarsec.javadoc.pdfdoclet.PDFDoclet"
        path = "${doclets}/itext-0.92.jar:${doclets}/pdfdoclet.jar" >                                                                                         
        <param name="-pdf"    value="${basedir}/documentation/pdf/javadocs.pdf" />             
        <param name="-config" value="${doclets}/pdfdoclet-mycore.properties" />  
      </doclet>             
 
    </javadoc>
  </target>

  <!-- =================================================================== --> 
  <!-- Create the PDF documentation from LaTeX sources                     --> 
  <!-- =================================================================== --> 
    
  <target name="tex2pdf" depends="init"> 
    <echo>Building the MyCoRe documentation as PDF from LaTeX sources... </echo> 

    <property name="tmpdir" value="${basedir}/documentation/tmp" />

    <delete dir="${tmpdir}" />
    <mkdir  dir="${tmpdir}" />
    <copy toDir="${tmpdir}"> <fileset dir="${basedir}/documentation/include" /> </copy>

    <antcall target="pdflatex"> <param name="TeXFile" value="Overview" /></antcall> 
    <antcall target="pdflatex"> <param name="TeXFile" value="UserGuide" /></antcall>
    <antcall target="pdflatex"> <param name="TeXFile" value="ProgGuide" /></antcall>
    <antcall target="pdflatex"> <param name="TeXFile" value="HowToWriteTheManual" /></antcall>

    <move toDir="${basedir}/documentation/pdf"><fileset dir="${tmpdir}" includes="*.pdf" /></move>
    <delete dir="${tmpdir}" />   
  </target> 

  <target name="pdflatex">
    <echo>Processing ${TeXFile} to PDF...</echo>

    <copy toDir="${tmpdir}"> <fileset dir="${basedir}/documentation/${TeXFile}" /> </copy>

    <echo>First run...</echo>
    <exec dir="${tmpdir}" executable="pdflatex" output="${tmpdir}/output.log"> 
      <arg line="--interaction nonstopmode ${TeXFile}" /> 
    </exec>
    <echo>Second run...</echo>
    <exec dir="${tmpdir}" executable="pdflatex" output="${tmpdir}/output.log"> 
      <arg line="--interaction nonstopmode ${TeXFile}" /> 
    </exec>
    <echo>Third run...</echo>
    <exec dir="${tmpdir}" executable="pdflatex"> 
      <arg line="--interaction nonstopmode ${TeXFile}" /> 
    </exec>
  </target>

  <!-- =================================================================== -->
  <!-- Remove the user created directories and files                       -->
  <!-- =================================================================== -->

  <target name="clean" description="Removes all files generated by this build file">
    <echo>Cleaning up...</echo>
    <delete dir="${basedir}/classes"  />
    <delete dir="${basedir}/documentation/html" />
    <delete dir="${basedir}/documentation/pdf" />
    <delete includeEmptyDirs="true" >
      <fileset dir="${basedir}/lib" includes="mycore*.jar" />
    </delete>
    <echo>---------------------------------------------------------</echo>
  </target>

  <!-- =================================================================== -->
  <!-- Update current working directory from CVS repository                -->
  <!-- =================================================================== -->

  <target name="update">
    <cvs
      cvsroot="${CVSRoot}"
      command="update -dP"
      dest="${basedir}"
    />
  </target>

  <!-- =================================================================== -->
  <!-- Build CVS ChangeLog                                                 -->
  <!-- =================================================================== -->

  <target name="changelog">
    <echo>

      Building CVS ChangeLog, please be patient...
    </echo>

    <antcall target="do-log"><param name="changelog-year" value="2003" /></antcall>
    <antcall target="do-log"><param name="changelog-year" value="2002" /></antcall>
    <antcall target="do-log"><param name="changelog-year" value="2001" /></antcall>
  </target>

  <target name="do-log" depends="init">
    <echo>Logging changes of the year ${changelog-year}...</echo>

    <mkdir dir="${basedir}/documentation/changelogs" />
    <cvschangelog 
      dir      = "."
      destfile = "${basedir}/documentation/changelogs/changelog-${changelog-year}.xml" 
      start    = "1 Jan ${changelog-year}"
      end      = "31 Dec ${changelog-year}"
    >
      <user displayname = "Frank Lützenkirchen / Essen"  userid = "dlclient" />
      <user displayname = "Frank Lützenkirchen / Essen"  userid = "mcrfluet" />
      <user displayname = "Holger Gollan / Essen"        userid = "mcrhgoll" />
      <user displayname = "Detlev Degenhardt / Freiburg" userid = "mcrddege" />
      <user displayname = "Harald Richter / Essen"       userid = "mcrhrich" />
      <user displayname = "Jens Kupferschmidt / Leipzig" userid = "mcrjkupf" />
      <user displayname = "Mathias Hegner / Jena"        userid = "mcrmhegn" />
      <user displayname = "Marc Schlüppmann / Essen"     userid = "mcrmslue" />
      <user displayname = "Thorsten Agemar / Göttingen"  userid = "mcrtagem" />
      <user displayname = "Thomas Scheffler / Jena"      userid = "mcrukroe" />
      <user displayname = "Werner Gresshoff / Münster"   userid = "mcrwgres" />
      <user displayname = "Benno Süselbeck / Münster"    userid = "mcrbsuse" />
      <user displayname = "Johannes Bühler / Greifswald" userid = "mcrjbueh" />
      <user displayname = "Maik Bunschkowski / Rostock"  userid = "mcrldbis" /> 
    </cvschangelog>

    <style 
      in           = "${basedir}/documentation/changelogs/changelog-${changelog-year}.xml" 
      out          = "${basedir}/documentation/changelogs/changelog-${changelog-year}.html" 
      style        = "${ant.home}/etc/changelog.xsl"
      classpathref = "mycore.classpath"
    >
      <param name="title"  expression="MyCoRe CVS ChangeLog for the year ${changelog-year}" />
      <param name="module" expression="mycore" />
      <param name="cvsweb" expression="http://www.mycore.de/repository/cgi-bin/viewcvs.cgi/" />
    </style>

    <delete file="${basedir}/documentation/changelogs/changelog-${changelog-year}.xml" />
  </target>

  <!-- =================================================================== -->
  <!-- Do work after a CVS commit...                                       -->
  <!-- =================================================================== -->

  <target name="postcommit">
    <antcall target="update"   />
    <antcall target="javadocs" />
    <antcall target="java2pdf" />
    <antcall target="tex2pdf"  />
    <antcall target="do-log"><param name="changelog-year" value="2003" /></antcall>
  </target>

</project>

