name: test

on: [ push, pull_request ]

env:
  MAVEN_OPTS: -Xmx1024M -Xss128M
  GECKODRIVER_VERSION: 0.27.0

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: 17
        distribution: temurin
        cache: 'maven'

    - name: Fetch Geckodriver cache
      id: geckodriver-cache
      uses: actions/cache@v4
      with:
        path: ~/geckodriver
        key: ${{ env.GECKODRIVER_VERSION }}

    - name: Fetch Geckodriver
      if: steps.geckodriver-cache.outputs.cache-hit != 'true'
      run: |
        mkdir ~/geckodriver
        curl -L https://github.com/mozilla/geckodriver/releases/download/v${GECKODRIVER_VERSION}/geckodriver-v${GECKODRIVER_VERSION}-linux64.tar.gz | \
          tar -C ~/geckodriver/ -xzvf-

    - name: Install Firefox ESR
      uses: browser-actions/setup-firefox@v1
      with:
        firefox-version: 'latest-esr'

    - name: Install Chrome (stable)
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: 'stable'
        install-chromedriver: true

    - name: Set up test dependencies
      run: |
        sudo apt install dbus-x11

        # Selenium wants to run non-ESR FF
        firefox --version

        # Geckodriver
        find ${GECKOWEBDRIVER}

        # Chromedriver
        find ${CHROMEWEBDRIVER}

        echo $PATH

        ~/geckodriver/geckodriver --version
        echo "${HOME}/geckodriver" >> $GITHUB_PATH

    - name: Build
      run: |
        export $(dbus-launch)
        mkdir ~/tmp
        export TMPDIR=~/tmp
        export FIREFOX_BIN=$(which firefox)
        export SELENIUM_BROWSER=firefox

        mvn -B -Plocal-testing,!standard-with-extra-repos clean install -Dlog4j.configurationFile=$PWD/ci/log4j2.xml -T2
        mvn -P!standard-with-extra-repos -B javadoc:javadoc

    - name: Upload logs on build failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          ./**/surefire-reports
          ./**/failsafe-reports
          ./**/screenshots
          ./**/*error*.log
          ./**/*test.log
