name: test

on: [ push, pull_request ]

env:
  MAVEN_OPTS: -Xmx1024M -Xss128M

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: 17
        distribution: temurin
        cache: 'maven'

    - name: Set up Browser
      run: |
        # Geckodriver
        echo ${GECKOWEBDRIVER} >> $GITHUB_PATH

        # Chromedriver
        echo ${CHROMEWEBDRIVER} >> $GITHUB_PATH

        firefox --version
        ${GECKOWEBDRIVER}/geckodriver --version

    - name: Build
      run: |
        mkdir ${{ runner.temp }}/${{ github.run_id }}.tmp
        export TMPDIR=${{ runner.temp }}/${{ github.run_id }}.tmp
        export FIREFOX_BIN=$(which firefox)
        export SELENIUM_BROWSER=firefox

        mvn org.apache.maven.plugins:maven-install-plugin:2.5.2:install-file -Dfile=.github/bibsonomy-model-3.9.4.jar
        mvn org.apache.maven.plugins:maven-install-plugin:2.5.2:install-file -Dfile=.github/bibsonomy-common-3.9.4.jar
        mvn org.apache.maven.plugins:maven-install-plugin:2.5.2:install-file -Dfile=.github/bibsonomy-bibtex-parser-3.9.4.jar

        mvn -B -Plocal-testing,!standard-with-extra-repos install -Dlog4j.configurationFile=$PWD/ci/log4j2.xml -T2
        mvn -P!standard-with-extra-repos -B javadoc:javadoc -T1C

    - name: Upload logs on build failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          ./**/surefire-reports
          ./**/failsafe-reports
          ./**/screenshots
          ./**/*error*.log
          ./**/*test.log
